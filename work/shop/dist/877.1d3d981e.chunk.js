"use strict";(self.webpackChunkreact_luo=self.webpackChunkreact_luo||[]).push([[877],{62961:function(e,t,n){n.r(t),n.d(t,{default:function(){return F}});n(83646);var a,r=n(85149),s=(n(19232),n(76606)),o=(n(97392),n(74572)),l=(n(22642),n(94099)),i=n(45443),c=(n(95760),n(79013)),u=(n(93542),n(41741)),d=n(34451),p=n(82173),m=(n(30153),n(11248)),f=(n(17510),n(7939)),h=(n(17652),n(27220)),y=(n(84113),n(66847)),k=n(81915),v=n(13475),w=n(15535),g=n(76815),C=n(81072),Z=n(13246),b=n(23080),E=(n(17819),n(24996)),S=(n(78464),n(88390)),x=(n(87119),n(3331)),D=n(99700),I=n.n(D),T=n(59496),P=n(18071),R=n(32699),B=n.n(R),M=n(45589),N=n(14154),A=n(27478),q=n(72423);function L(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,Z.Z)(e);if(t){var r=(0,Z.Z)(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return(0,C.Z)(this,n)}}var U=x.Z.TreeNode,O=S.default.Option,J=E.Z.TextArea,F=(0,P.$j)((function(e){return{userinfo:e.app.userinfo,powersCode:e.app.powersCode,roles:e.sys.roles}}),(function(e){return{addPower:e.sys.addPower,getMenus:e.sys.getMenus,upPower:e.sys.upPower,delPower:e.sys.delPower,getPowerDataByMenuId:e.sys.getPowerDataByMenuId,updateUserInfo:e.app.updateUserInfo,setPowersByRoleIds:e.sys.setPowersByRoleIds,getAllRoles:e.sys.getAllRoles}}))(a=function(e){(0,g.Z)(a,e);var t,n=L(a);function a(e){var t;return(0,k.Z)(this,a),t=n.call(this,e),(0,b.Z)((0,w.Z)(t),"onTreeSelect",(function(e,n){n.selected?(t.getData(e[0]),t.setState({treeSelect:{title:n.node.title,id:n.node.id}})):t.setState({treeSelect:{},data:[]})})),(0,b.Z)((0,w.Z)(t),"getNameByParentId",(function(e){var n=t.state.data.find((function(t){return t.id===e}));return n?n.title:void 0})),(0,b.Z)((0,w.Z)(t),"onModalShow",(function(e,n){t.setState({modalShow:!0,nowData:e,operateType:n,formParent:"add"===n?{label:void 0,value:void 0}:{label:t.getNameByParentId(e.parent),value:e.parent},rolesCheckboxChose:e&&e.id?t.props.roles.filter((function(t){var n=t.menuAndPowers.find((function(t){return t.menuId===e.menu}));return!!n&&n.powers.includes(e.id)})).map((function(e){return e.id})):[]}),setTimeout((function(){"add"===n?t.form.current.resetFields():t.form.current.setFieldsValue({formConditions:e.conditions,formDesc:e.desc,formCode:e.code,formSorts:e.sorts,formTitle:e.title})}))})),(0,b.Z)((0,w.Z)(t),"onClose",(function(){t.setState({modalShow:!1})})),(0,b.Z)((0,w.Z)(t),"onDel",(function(e){var n={id:e.id};t.setState({loading:!0}),t.props.delPower(n).then((function(e){200===e.status?(t.getData(t.state.treeSelect.id),t.props.updateUserInfo(),y.default.success("删除成功")):y.default.error(e.message)}))})),(0,b.Z)((0,w.Z)(t),"makeColumns",(function(){return[{title:"序号",dataIndex:"serial",key:"serial"},{title:"权限名称",dataIndex:"title",key:"title"},{title:"Code",dataIndex:"code",key:"code"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"状态",dataIndex:"conditions",key:"conditions",render:function(e,t){return 1===e?T.createElement("span",{style:{color:"green"}},"启用"):T.createElement("span",{style:{color:"red"}},"禁用")}},{title:"操作",key:"control",width:120,render:function(e,n){var a=[],r=t.props.powersCode;r.includes("power:query")&&a.push(T.createElement("span",{key:"0",className:"control-btn green",onClick:function(){return t.onModalShow(n,"see")}},T.createElement(h.default,{placement:"top",title:"查看"},T.createElement(M.Z,null)))),r.includes("power:up")&&a.push(T.createElement("span",{key:"1",className:"control-btn blue",onClick:function(){return t.onModalShow(n,"up")}},T.createElement(h.default,{placement:"top",title:"修改"},T.createElement(N.Z,null)))),r.includes("power:del")&&a.push(T.createElement(f.Z,{key:"2",title:"确定删除吗?",okText:"确定",cancelText:"取消",onConfirm:function(){return t.onDel(n)}},T.createElement("span",{className:"control-btn red"},T.createElement(h.default,{placement:"top",title:"删除"},T.createElement(A.Z,null)))));var s=[];return a.forEach((function(e,t){t&&s.push(T.createElement(m.Z,{key:"line".concat(t),type:"vertical"})),s.push(e)})),s}}]})),(0,b.Z)((0,w.Z)(t),"makeRolesCheckbox",(function(){return t.props.roles.map((function(e){return{label:e.title,value:e.id}}))})),(0,b.Z)((0,w.Z)(t),"onRolesCheckboxChange",(function(e){t.setState({rolesCheckboxChose:e})})),t.form=T.createRef(),t.state={data:[],sourceData:[],loading:!1,treeSelect:{},nowData:null,operateType:"add",modalShow:!1,modalLoading:!1,menuChoseShow:!1,formParent:{label:void 0,value:void 0},rolesCheckboxChose:[]},t}return(0,v.Z)(a,[{key:"componentDidMount",value:function(){0===this.props.userinfo.menus.length?this.getMenuData():this.makeSourceData(this.props.userinfo.menus),this.props.getAllRoles(),this.getData()}},{key:"componentDidUpdate",value:function(e){e.userinfo.menus!==this.props.userinfo.menus&&this.makeSourceData(this.props.userinfo.menus)}},{key:"getData",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=this.props.powersCode;if(n.includes("power:query")){this.setState({loading:!0});var a={menuId:Number(t)||null};this.props.getPowerDataByMenuId(a).then((function(t){200===t.status&&e.setState({data:t.data}),e.setState({loading:!1})})).catch((function(){e.setState({loading:!1})}))}}},{key:"getMenuData",value:function(){this.props.getMenus()}},{key:"makeSourceData",value:function(e){var t=B().cloneDeep(e);t.forEach((function(e){e.key=String(e.id)})),t.sort((function(e,t){return e.sorts-t.sorts}));var n=this.dataToJson(null,t)||[];this.setState({sourceData:n})}},{key:"dataToJson",value:function(e,t){var n,a=this;return(n=e?t.filter((function(t){return t.parent===e.id})):t.filter((function(e){return!e.parent}))).forEach((function(e){return e.children=a.dataToJson(e,t)})),n.length?n:null}},{key:"makeTreeDom",value:function(e){var t=this;return e.map((function(e){return e.children?T.createElement(U,{title:e.title,key:"".concat(e.id),p:e.parent},t.makeTreeDom(e.children)):T.createElement(U,{title:e.title,key:"".concat(e.id),id:e.id,p:e.parent})}))}},{key:"onOk",value:(t=(0,p.Z)(I().mark((function e(){var t,n,a;return I().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("see"!==this.state.operateType){e.next=3;break}return this.onClose(),e.abrupt("return");case 3:return e.prev=3,e.next=6,this.form.current.validateFields();case 6:if(t=e.sent,n={title:t.formTitle,code:t.formCode,menu:this.state.treeSelect.id,sorts:t.formSorts,desc:t.formDesc,conditions:t.formConditions},this.setState({modalLoading:!0}),"add"!==this.state.operateType){e.next=30;break}return e.prev=10,e.next=13,this.props.addPower(n);case 13:if(200!==(a=e.sent).status){e.next=24;break}return y.default.success("添加成功"),this.getData(this.state.treeSelect.id),this.onClose(),e.next=20,this.setPowersByRoleIds(a.data.id,this.state.rolesCheckboxChose);case 20:this.props.updateUserInfo(),this.props.getAllRoles(),e.next=25;break;case 24:y.default.error("添加失败");case 25:return e.prev=25,this.setState({modalLoading:!1}),e.finish(25);case 28:e.next=49;break;case 30:return e.prev=30,n.id=this.state.nowData.id,e.next=34,this.props.upPower(n);case 34:if(200!==e.sent.status){e.next=45;break}return y.default.success("修改成功"),this.getData(this.state.treeSelect.id),this.onClose(),e.next=41,this.setPowersByRoleIds(n.id,this.state.rolesCheckboxChose);case 41:this.props.getAllRoles(),this.props.updateUserInfo(),e.next=46;break;case 45:y.default.error("修改失败");case 46:return e.prev=46,this.setState({modalLoading:!1}),e.finish(46);case 49:e.next=53;break;case 51:e.prev=51,e.t0=e.catch(3);case 53:case"end":return e.stop()}}),e,this,[[3,51],[10,,25,28],[30,,46,49]])}))),function(){return t.apply(this,arguments)})},{key:"setPowersByRoleIds",value:function(e,t){this.props.userinfo;var n=this.props.roles.map((function(n){var a=new Set(n.menuAndPowers.reduce((function(e,t){return[].concat((0,d.Z)(e),(0,d.Z)(t.powers))}),[]));return t.includes(n.id)?a.add(e):a.delete(e),{id:n.id,menus:n.menuAndPowers.map((function(e){return e.menuId})),powers:Array.from(a)}}));this.props.setPowersByRoleIds(n)}},{key:"makeData",value:function(e){return e?e.map((function(e,t){return{key:t,id:e.id,menu:e.menu,title:e.title,code:e.code,desc:e.desc,sorts:e.sorts,conditions:e.conditions,serial:t+1}})):[]}},{key:"render",value:function(){var e,t,n=this,a=this.props.powersCode,d={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};return T.createElement("div",{className:"page-power-admin"},T.createElement("div",{className:"l"},T.createElement("div",{className:"title"},"目录结构"),T.createElement("div",null,T.createElement(x.Z,{onSelect:this.onTreeSelect,treeData:this.state.sourceData}))),T.createElement("div",{className:"r"},T.createElement("div",{className:"searchBox"},T.createElement("ul",null,T.createElement("li",null,T.createElement(u.default,{type:"primary",icon:T.createElement(q.Z,null),onClick:function(){return n.onModalShow(null,"add")},disabled:!(this.state.treeSelect.id&&a.includes("power:add"))},"添加".concat(this.state.treeSelect.title||"","权限"))))),T.createElement(c.Z,{className:"diy-table",columns:this.makeColumns(),loading:this.state.loading,dataSource:this.makeData(this.state.data),pagination:{showQuickJumper:!0,showTotal:function(e,t){return"共 ".concat(e," 条数据")}}})),T.createElement(r.Z,{title:"".concat({add:"新增",up:"修改",see:"查看"}[this.state.operateType],"权限: ").concat(this.state.treeSelect.title,"->").concat(null!==(e=null===(t=this.state.nowData)||void 0===t?void 0:t.title)&&void 0!==e?e:""),visible:this.state.modalShow,onOk:function(){return n.onOk()},onCancel:this.onClose,confirmLoading:this.state.modalLoading},T.createElement(l.Z,{ref:this.form,initialValues:{formConditions:1}},T.createElement(l.Z.Item,(0,i.Z)({label:"权限名",name:"formTitle"},d,{rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}]}),T.createElement(E.Z,{placeholder:"请输入权限名",disabled:"see"===this.state.operateType})),T.createElement(l.Z.Item,(0,i.Z)({label:"Code",name:"formCode"},d,{rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}]}),T.createElement(E.Z,{placeholder:"请输入权限Code",disabled:"see"===this.state.operateType})),T.createElement(l.Z.Item,(0,i.Z)({label:"描述",name:"formDesc"},d,{rules:[{max:100,message:"最多输入100位字符"}]}),T.createElement(J,{rows:4,disabled:"see"===this.state.operateType,placeholoder:"请输入描述",autosize:{minRows:2,maxRows:6}})),T.createElement(l.Z.Item,(0,i.Z)({label:"排序",name:"formSorts"},d,{rules:[{required:!0,message:"请输入排序号"}]}),T.createElement(o.Z,{min:0,max:99999,style:{width:"100%"},disabled:"see"===this.state.operateType})),T.createElement(l.Z.Item,(0,i.Z)({label:"状态",name:"formConditions"},d,{rules:[{required:!0,message:"请选择状态"}]}),T.createElement(S.default,{disabled:"see"===this.state.operateType},T.createElement(O,{key:1,value:1},"启用"),T.createElement(O,{key:-1,value:-1},"禁用"))),T.createElement(l.Z.Item,(0,i.Z)({label:"赋予"},d),T.createElement(s.default.Group,{disabled:"see"===this.state.operateType,options:this.makeRolesCheckbox(),value:this.state.rolesCheckboxChose,onChange:this.onRolesCheckboxChange})))))}}]),a}(T.Component))||a}}]);