import{r as u,l as _,j as s,a as ee,b as M,B as K,t as O,m as h,T as v}from"./index-33213bd0.js";import{F as f,u as se,I as C}from"./useMount-751534fc.js";import{M as F,T as ae,u as D,P as oe,d as q,S as R,a as le,E as te,b as ne,c as re,D as ie}from"./index-513cd105.js";import{S as ce,E as de}from"./SearchOutlined-c3244f38.js";function ue(n){const[j,m]=u.useState([]);u.useEffect(()=>{m(n.defaultKeys.map(c=>`${c}`))},[n.defaultKeys]);const p=u.useCallback((c,o)=>{let r;return c?r=o.filter(i=>{var y;return((y=i.parent)==null?void 0:y.id)===c.id}):r=o.filter(i=>!i.parent),r.forEach(i=>i.children=p(i,o)),r.length?r:void 0},[]),T=u.useCallback(()=>{const c=n.data.filter(o=>j.includes(`${o.id}`));n.onOk&&n.onOk(j,c)},[n,j]),N=u.useCallback(()=>{n.onClose()},[n]),P=u.useCallback(c=>{m(c)},[]),x=u.useCallback(c=>{const o=[];for(let r=0;r<c.length;r++){const i={...c[r]};i.children&&(i.children=x(i.children));const y={...i,key:i.id};o.push(y)}return o},[]),d=u.useMemo(()=>{const c=_.cloneDeep(n.data),o=x(c);return o.forEach(r=>{r.key=String(r.id)}),p(void 0,o)||[]},[n.data,p]);return s.jsx(F,{title:n.title||"请选择",visible:n.visible,wrapClassName:"menuTreeModal",confirmLoading:n.loading,onOk:T,onCancel:N,children:s.jsx(ae,{checkable:!0,selectable:!1,checkedKeys:j,onCheck:P,treeData:d})})}const{TextArea:me}=C,{Option:I}=R,w={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function ye(){const n=ee(),j=M(e=>e.app.userinfo),m=M(e=>e.app.powersCode),[p]=f.useForm(),[T,N]=u.useState([]),[P,x]=u.useState(!1),[d,c]=D({pageNum:1,pageSize:10,total:0}),[o,r]=D({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[i,y]=D({username:void 0,conditions:void 0}),[k,b]=D({roleData:[],roleTreeLoading:!1,roleTreeShow:!1,roleTreeDefault:[]});se(()=>{g(d),A()});const A=async()=>{try{const e=await n.sys.getAllRoles();e&&e.status===200&&b({roleData:e.data})}catch{}};async function g(e){if(!m.includes("user:query"))return;const a={pageNum:e.pageNum,pageSize:e.pageSize,username:i.username,conditions:i.conditions};x(!0);try{const l=await n.sys.getUserList(O.clearNull(a));l&&l.status===200?(N(l.data.list),c({pageNum:e.pageNum,pageSize:e.pageSize,total:l.data.total})):h.error((l==null?void 0:l.message)??"数据获取失败")}finally{x(!1)}}const $=e=>{e.target.value.length<20&&y({username:e.target.value})},B=e=>{y({conditions:e})},J=()=>{g(d)},E=(e,a)=>{r({modalShow:!0,nowData:e,operateType:a}),setTimeout(()=>{a==="add"?p.resetFields():e&&p.setFieldsValue({formConditions:e.conditions,formDesc:e.desc,formUsername:e.username,formPhone:e.phone,formEmail:e.email,formPassword:e.password})})},V=async()=>{var e;if(o.operateType==="see"){S();return}try{const a=await p.validateFields();r({modalLoading:!0});const l={username:a.formUsername,password:a.formPassword,phone:a.formPhone,email:a.formEmail,desc:a.formDesc,conditions:a.formConditions};if(o.operateType==="add")try{const t=await n.sys.addUser(l);t&&t.status===200?(h.success("添加成功"),g(d),S()):h.error((t==null?void 0:t.message)??"操作失败")}finally{r({modalLoading:!1})}else{l.id=(e=o.nowData)==null?void 0:e.id;try{const t=await n.sys.upUser(l);t&&t.status===200?(h.success("修改成功"),g(d),S()):h.error((t==null?void 0:t.message)??"操作失败")}finally{r({modalLoading:!1})}}}catch{}},G=async e=>{x(!0);try{const a=await n.sys.delUser({id:e});a&&a.status===200?(h.success("删除成功"),g(d)):h.error((a==null?void 0:a.message)??"操作失败")}finally{x(!1)}},S=()=>{r({modalShow:!1})},Q=e=>{r({nowData:e}),b({roleTreeShow:!0,roleTreeDefault:e.roles||[]})},H=async e=>{var l;if(!((l=o.nowData)!=null&&l.id)){h.error("未获取到该条数据id");return}const a={id:o.nowData.id,roles:e.map(t=>Number(t))};b({roleTreeLoading:!0});try{const t=await n.sys.setUserRoles(a);t&&t.status===200?(h.success("分配成功"),g(d),U()):h.error((t==null?void 0:t.message)??"操作失败")}finally{b({roleTreeLoading:!1})}},U=()=>{b({roleTreeShow:!1})},W=(e,a)=>{g({pageNum:e,pageSize:a})},X=[{title:"序号",dataIndex:"serial",key:"serial"},{title:"用户名",dataIndex:"username",key:"username"},{title:"电话",dataIndex:"phone",key:"phone"},{title:"邮箱",dataIndex:"email",key:"email"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>e===1?s.jsx("span",{style:{color:"green"},children:"启用"}):s.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:200,render:(e,a)=>{const l=[],t=j.userBasicInfo||{id:-1};m.includes("user:query")&&l.push(s.jsx("span",{className:"control-btn green",onClick:()=>E(a,"see"),children:s.jsx(v,{placement:"top",title:"查看",children:s.jsx(te,{})})},"0")),m.includes("user:up")&&l.push(s.jsx("span",{className:"control-btn blue",onClick:()=>E(a,"up"),children:s.jsx(v,{placement:"top",title:"修改",children:s.jsx(ne,{})})},"1")),m.includes("user:role")&&l.push(s.jsx("span",{className:"control-btn blue",onClick:()=>Q(a),children:s.jsx(v,{placement:"top",title:"分配角色",children:s.jsx(de,{})})},"2")),m.includes("user:del")&&t.id!==a.id&&l.push(s.jsx(re,{title:"确定删除吗?",onConfirm:()=>G(a.id),okText:"确定",cancelText:"取消",children:s.jsx("span",{className:"control-btn red",children:s.jsx(v,{placement:"top",title:"删除",children:s.jsx(ie,{})})})},"3"));const L=[];return l.forEach((Z,z)=>{z&&L.push(s.jsx(q,{type:"vertical"},`line${z}`)),L.push(Z)}),L}}],Y=u.useMemo(()=>T.map((e,a)=>({key:a,id:e.id,serial:a+1+(d.pageNum-1)*d.pageSize,username:e.username,password:e.password,phone:e.phone,email:e.email,desc:e.desc,conditions:e.conditions,control:e.id,roles:e.roles})),[d,T]);return s.jsxs("div",{children:[s.jsxs("div",{className:"g-search",children:[s.jsx("ul",{className:"search-func",children:s.jsx("li",{children:s.jsx(K,{type:"primary",icon:s.jsx(oe,{}),disabled:!m.includes("user:add"),onClick:()=>E(null,"add"),children:"添加用户"})})}),s.jsx(q,{type:"vertical"}),m.includes("user:query")&&s.jsxs("ul",{className:"search-ul",children:[s.jsx("li",{children:s.jsx(C,{placeholder:"请输入用户名",onChange:$,value:i.username})}),s.jsx("li",{children:s.jsxs(R,{placeholder:"请选择状态",allowClear:!0,style:{width:"200px"},onChange:B,value:i.conditions,children:[s.jsx(I,{value:1,children:"启用"}),s.jsx(I,{value:-1,children:"禁用"})]})}),s.jsx("li",{children:s.jsx(K,{type:"primary",icon:s.jsx(ce,{}),onClick:J,children:"搜索"})})]})]}),s.jsx("div",{className:"diy-table",children:s.jsx(le,{columns:X,loading:P,dataSource:Y,pagination:{total:d.total,current:d.pageNum,pageSize:d.pageSize,showQuickJumper:!0,showTotal:e=>`共 ${e} 条数据`,onChange:W}})}),s.jsx(F,{title:{add:"新增",up:"修改",see:"查看"}[o.operateType],visible:o.modalShow,onOk:V,onCancel:S,confirmLoading:o.modalLoading,children:s.jsxs(f,{form:p,initialValues:{formConditions:1},children:[s.jsx(f.Item,{label:"用户名",name:"formUsername",...w,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:s.jsx(C,{placeholder:"请输入用户名",disabled:o.operateType==="see"})}),s.jsx(f.Item,{label:"密码",name:"formPassword",...w,rules:[{required:!0,whitespace:!0,message:"必填"},{min:6,message:"最少输入6位字符"},{max:18,message:"最多输入18位字符"}],children:s.jsx(C,{type:"password",placeholder:"请输入密码",disabled:o.operateType==="see"})}),s.jsx(f.Item,{label:"电话",name:"formPhone",...w,rules:[()=>({validator:(e,a)=>{const l=a;return l&&!O.checkPhone(l)?Promise.reject("请输入有效的手机号码"):Promise.resolve()}})],children:s.jsx(C,{placeholder:"请输入手机号",maxLength:11,disabled:o.operateType==="see"})}),s.jsx(f.Item,{label:"邮箱",name:"formEmail",...w,rules:[()=>({validator:(e,a)=>{const l=a;return l&&!O.checkEmail(l)?Promise.reject("请输入有效的邮箱地址"):Promise.resolve()}})],children:s.jsx(C,{placeholder:"请输入邮箱地址",disabled:o.operateType==="see"})}),s.jsx(f.Item,{label:"描述",name:"formDesc",...w,rules:[{max:100,message:"最多输入100个字符"}],children:s.jsx(me,{rows:4,disabled:o.operateType==="see",autoSize:{minRows:2,maxRows:6}})}),s.jsx(f.Item,{label:"状态",name:"formConditions",...w,rules:[{required:!0,message:"请选择状态"}],children:s.jsxs(R,{disabled:o.operateType==="see",children:[s.jsx(I,{value:1,children:"启用"},1),s.jsx(I,{value:-1,children:"禁用"},-1)]})})]})}),s.jsx(ue,{title:"分配角色",data:k.roleData,visible:k.roleTreeShow,defaultKeys:k.roleTreeDefault,loading:k.roleTreeLoading,onOk:H,onClose:U})]})}export{ye as default};
