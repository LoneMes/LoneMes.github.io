import{r as h,l as Z,j as s,a as _,b as B,B as U,m as j,T as O,t as ee}from"./index-7a44722b.js";import{C as se,F as S,u as te,I as E}from"./useMount-de377e1b.js";import{M as J,e as ne,a as K,u as v,P as oe,d as $,S as M,E as ae,b as le,c as re,D as ie}from"./index-b47999ab.js";import{I as ce}from"./index-a384b88b.js";import{S as de,E as ue}from"./SearchOutlined-c5852a61.js";function me(a){const[m,T]=h.useState([]),[p,w]=h.useState([]);h.useEffect(()=>{T(a.defaultChecked.menus||[]),w(a.defaultChecked.powers||[])},[a.defaultChecked]);const P=h.useCallback(()=>{var l;(l=a.onOk)==null||l.call(a,{menus:m,powers:p})},[a,p,m]),L=h.useCallback(()=>{a.onClose()},[a]),g=h.useCallback(l=>!!p.find(r=>r===l),[p]),u=h.useCallback((l,r,o)=>{console.log("哈？",o);const t=[...p];let f=[...m];if(l.target.checked)t.push(r),f=Array.from(new Set([o.id,...m]));else{t.splice(t.indexOf(r),1);const y=o.powers.map(k=>k.id);p.some(k=>k!==r&&y.indexOf(k)>=0)||f.splice(f.indexOf(o.id),1)}w(t),T(f)},[p,m]),b=h.useCallback((l,r)=>{let o;return l?o=r.filter(t=>t.parent===l.id):o=r.filter(t=>!t.parent),o.forEach(t=>{t.children=b(t,r),t.key=t.id}),o.length?o:void 0},[]),c=h.useCallback(l=>{const r=[];for(let o=0;o<l.length;o++){const t={...l[o]};t.children&&(t.children=c(t.children));const f={...t,key:t.id};r.push(f)}return r},[]),x=h.useMemo(()=>{const l=Z.cloneDeep(a.data),r=c(l);return r.sort((o,t)=>o.sorts-t.sorts),b(void 0,r)||[]},[a.data,b]),C=h.useMemo(()=>({onChange:l=>{T(l.map(r=>Number(r)))},onSelect:(l,r)=>{const o=a.data.find(t=>t.id===l.id);if(r){if(o&&Array.isArray(o.powers)){const t=Array.from(new Set([...o.powers.map(f=>f.id),...p]));w(t)}}else if(o&&Array.isArray(o.powers)){const t=o.powers.map(y=>y.id),f=p.filter(y=>t.indexOf(y)<0);w(f)}},onSelectAll:l=>{w(l?a.data.reduce((r,o)=>[...r,...o.powers.map(t=>t.id)],[]):[])},selectedRowKeys:m}),[a.data,m,p]),D=h.useMemo(()=>[{title:"菜单",dataIndex:"title",key:"title",width:"30%"},{title:"权限",dataIndex:"powers",key:"powers",width:"70%",render:(l,r)=>(console.log("东西呢：",l),l?l.map((o,t)=>s.jsx(se,{checked:g(o.id),onChange:f=>u(f,o.id,r),children:o.title},t)):null)}],[g,u]);return s.jsx(J,{className:"menu-tree-table",zIndex:1001,width:750,title:a.title||"请选择",visible:a.modalShow,onOk:P,onCancel:L,confirmLoading:a.loading,children:a.initloading?s.jsx("div",{style:{textAlign:"center"},children:s.jsx(ne,{tip:"加载中…"})}):s.jsx(K,{columns:D,rowSelection:C,dataSource:x,pagination:!1,defaultExpandAllRows:!0})})}const{TextArea:pe}=E,{Option:N}=M,A={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function ye(){const a=_(),m=B(e=>e.app.powersCode),T=B(e=>e.sys.powerTreeData),[p]=S.useForm(),[w,P]=h.useState([]),[L,g]=h.useState(!1),[u,b]=v({pageNum:1,pageSize:10,total:0}),[c,x]=v({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[C,D]=v({title:void 0,conditions:void 0}),[l,r]=v({treeOnOkLoading:!1,powerTreeShow:!1,powerTreeDefault:{menus:[],powers:[]}});te(()=>{t(u),o()});const o=()=>{a.sys.getAllMenusAndPowers()},t=async e=>{if(!m.includes("role:query"))return;const n={pageNum:e.pageNum,pageSize:e.pageSize,title:C.title,conditions:C.conditions};g(!0);try{const i=await a.sys.getRoles(ee.clearNull(n));i&&i.status===200?(P(i.data.list),b({total:i.data.total,pageNum:e.pageNum,pageSize:e.pageSize})):j.error((i==null?void 0:i.message)??"获取失败")}finally{g(!1)}},f=e=>{e.target.value.length<20&&D({title:e.target.value})},y=e=>{D({conditions:e})},k=()=>{t(u)},z=(e,n)=>{x({modalShow:!0,nowData:e,operateType:n}),setTimeout(()=>{n==="add"?p.resetFields():p.setFieldsValue({formConditions:e==null?void 0:e.conditions,formDesc:e==null?void 0:e.desc,formSorts:e==null?void 0:e.sorts,formTitle:e==null?void 0:e.title})})},V=async()=>{var e;if(c.operateType==="see"){I();return}try{const n=await p.validateFields();x({modalLoading:!0});const i={title:n.formTitle,desc:n.formDesc,sorts:n.formSorts,conditions:n.formConditions};if(c.operateType==="add")try{const d=await a.sys.addRole(i);d&&d.status===200&&(j.success("添加成功"),t(u),a.app.updateUserInfo(null),I())}finally{x({modalLoading:!1})}else{i.id=(e=c==null?void 0:c.nowData)==null?void 0:e.id;try{const d=await a.sys.upRole(i);d&&d.status===200&&(j.success("修改成功"),t(u),a.app.updateUserInfo(null),I())}finally{x({modalLoading:!1})}}}catch{}},Q=async e=>{g(!0);try{const n=await a.sys.delRole({id:e});n&&n.status===200?(j.success("删除成功"),t(u),a.app.updateUserInfo(null)):j.error((n==null?void 0:n.message)??"操作失败")}finally{g(!1)}},I=()=>{x({modalShow:!1})},G=e=>{const n=e.menuAndPowers.map(d=>d.menuId),i=e.menuAndPowers.reduce((d,R)=>[...d,...R.powers],[]);x({nowData:e}),r({powerTreeShow:!0,powerTreeDefault:{menus:n,powers:i}})},H=async e=>{var i;if(!((i=c==null?void 0:c.nowData)!=null&&i.id)){j.error("该数据没有ID");return}const n={id:c.nowData.id,menus:e.menus,powers:e.powers};r({treeOnOkLoading:!0});try{const d=await a.sys.setPowersByRoleId(n);d&&d.status===200?(t(u),a.app.updateUserInfo(null),q()):j.error((d==null?void 0:d.message)??"权限分配失败")}finally{r({treeOnOkLoading:!1})}},q=()=>{r({powerTreeShow:!1})},W=(e,n)=>{t({pageNum:e,pageSize:n||u.pageSize})},X=[{title:"序号",dataIndex:"serial",key:"serial"},{title:"角色名",dataIndex:"title",key:"title"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"排序",dataIndex:"sorts",key:"sorts"},{title:"状态",dataIndex:"conditions",key:"conditions",render:(e,n)=>e===1?s.jsx("span",{style:{color:"green"},children:"启用"}):s.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:200,render:(e,n)=>{const i=[];m.includes("role:query")&&i.push(s.jsx("span",{className:"control-btn green",onClick:()=>z(n,"see"),children:s.jsx(O,{placement:"top",title:"查看",children:s.jsx(ae,{})})},"0")),m.includes("role:up")&&i.push(s.jsx("span",{className:"control-btn blue",onClick:()=>z(n,"up"),children:s.jsx(O,{placement:"top",title:"修改",children:s.jsx(le,{})})},"1")),m.includes("role:power")&&i.push(s.jsx("span",{className:"control-btn blue",onClick:()=>G(n),children:s.jsx(O,{placement:"top",title:"分配权限",children:s.jsx(ue,{})})},"2")),m.includes("role:del")&&i.push(s.jsx(re,{title:"确定删除吗?",onConfirm:()=>Q(n.id),okText:"确定",cancelText:"取消",children:s.jsx("span",{className:"control-btn red",children:s.jsx(O,{placement:"top",title:"删除",children:s.jsx(ie,{})})})},"3"));const d=[];return i.forEach((R,F)=>{F&&d.push(s.jsx($,{type:"vertical"},`line${F}`)),d.push(R)}),d}}],Y=h.useMemo(()=>w.map((e,n)=>({key:n,id:e.id,serial:n+1+(u.pageNum-1)*u.pageSize,title:e.title,desc:e.desc,sorts:e.sorts,conditions:e.conditions,control:e.id,menuAndPowers:e.menuAndPowers})),[u,w]);return s.jsxs("div",{children:[s.jsxs("div",{className:"g-search",children:[s.jsx("ul",{className:"search-func",children:s.jsx("li",{children:s.jsx(U,{type:"primary",icon:s.jsx(oe,{}),disabled:!m.includes("role:add"),onClick:()=>z(null,"add"),children:"添加角色"})})}),s.jsx($,{type:"vertical"}),m.includes("role:query")&&s.jsxs("ul",{className:"search-ul",children:[s.jsx("li",{children:s.jsx(E,{placeholder:"请输入角色名",onChange:f,value:C.title})}),s.jsx("li",{children:s.jsxs(M,{placeholder:"请选择状态",allowClear:!0,style:{width:"200px"},onChange:y,value:C.conditions,children:[s.jsx(N,{value:1,children:"启用"}),s.jsx(N,{value:-1,children:"禁用"})]})}),s.jsx("li",{children:s.jsx(U,{type:"primary",icon:s.jsx(de,{}),onClick:k,children:"搜索"})})]})]}),s.jsx("div",{className:"diy-table",children:s.jsx(K,{columns:X,loading:L,dataSource:Y,pagination:{total:u.total,current:u.pageNum,pageSize:u.pageSize,showQuickJumper:!0,showTotal:e=>`共 ${e} 条数据`,onChange:(e,n)=>W(e,n)}})}),s.jsx(J,{title:{add:"新增",up:"修改",see:"查看"}[c.operateType],visible:c.modalShow,onOk:()=>V(),onCancel:()=>I(),confirmLoading:c.modalLoading,children:s.jsxs(S,{form:p,initialValues:{formConditions:1},children:[s.jsx(S.Item,{label:"角色名",name:"formTitle",...A,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:s.jsx(E,{placeholder:"请输入角色名",disabled:c.operateType==="see"})}),s.jsx(S.Item,{label:"描述",name:"formDesc",...A,rules:[{max:100,message:"最多输入100个字符"}],children:s.jsx(pe,{rows:4,disabled:c.operateType==="see",autoSize:{minRows:2,maxRows:6}})}),s.jsx(S.Item,{label:"排序",name:"formSorts",...A,rules:[{required:!0,message:"请输入排序号"}],children:s.jsx(ce,{min:0,max:99999,style:{width:"100%"},disabled:c.operateType==="see"})}),s.jsx(S.Item,{label:"状态",name:"formConditions",...A,rules:[{required:!0,message:"请选择状态"}],children:s.jsxs(M,{disabled:c.operateType==="see",children:[s.jsx(N,{value:1,children:"启用"},1),s.jsx(N,{value:-1,children:"禁用"},-1)]})})]})}),s.jsx(me,{title:c.nowData?`分配权限：${c.nowData.title}`:"分配权限",data:T,defaultChecked:l.powerTreeDefault,loading:l.treeOnOkLoading,modalShow:l.powerTreeShow,onOk:H,onClose:q})]})}export{ye as default};
