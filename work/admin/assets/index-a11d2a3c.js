import{a as K,b as D,r as i,l as Q,j as s,B as H,m as p,T as S}from"./index-33213bd0.js";import{u as W,T as X,P as Y,a as Z,M as _,S as q,E as ee,b as se,c as oe,D as te,d as le}from"./index-513cd105.js";import{F as c,u as ne,I as k,C as re}from"./useMount-751534fc.js";import{I as ae}from"./index-0ed36c48.js";const{Option:E}=q,{TextArea:ie}=k,m={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};function me(){var L;const r=K(),h=D(e=>e.app.powersCode),y=D(e=>e.sys.roles),b=D(e=>e.app.userinfo),[w]=c.useForm(),[v,P]=i.useState([]),[B,C]=i.useState(!1),[n,f]=W({operateType:"add",nowData:null,modalShow:!1,modalLoading:!1}),[g,M]=i.useState([]),[u,N]=i.useState({});ne(()=>{b.menus.length===0&&r.sys.getMenus(),r.sys.getAllRoles(),x()});const x=async(e=null)=>{if(!h.includes("power:query"))return;C(!0);const t={menuId:Number(e)||null};try{const o=await r.sys.getPowerDataByMenuId(t);o&&o.status===200&&P(o.data)}finally{C(!1)}},T=i.useCallback((e,t)=>{let o;return e?o=t.filter(l=>l.parent===e.id):o=t.filter(l=>!l.parent),o.forEach(l=>l.children=T(l,t)),o.length?o:void 0},[]),A=i.useCallback(e=>{const t=[];for(let o=0;o<e.length;o++){const l={...e[o]};l.children&&(l.children=A(l.children));const a={...l,key:l.id};t.push(a)}return t},[]),F=(e,t)=>{t.selected?(x(e[0]),N({title:t.node.title,id:t.node.id})):(N({}),P([]))},I=(e,t)=>{f({modalShow:!0,nowData:e,operateType:t}),M(e&&e.id?y.filter(o=>{var a;const l=(a=o.menuAndPowers)==null?void 0:a.find(d=>d.menuId===e.menu);return l?l.powers.includes(e.id):!1}).map(o=>o.id):[]),setTimeout(()=>{t==="add"?w.resetFields():w.setFieldsValue({formConditions:e==null?void 0:e.conditions,formDesc:e==null?void 0:e.desc,formCode:e==null?void 0:e.code,formSorts:e==null?void 0:e.sorts,formTitle:e==null?void 0:e.title})})},j=()=>{f({modalShow:!1})},O=async()=>{var e;if(n.operateType==="see"){j();return}try{const t=await w.validateFields(),o={title:t.formTitle,code:t.formCode,menu:u.id||0,sorts:t.formSorts,desc:t.formDesc,conditions:t.formConditions};if(f({modalLoading:!0}),n.operateType==="add")try{const l=await r.sys.addPower(o);l&&l.status===200?(p.success("添加成功"),x(u.id),j(),await R(l.data.id,g),r.app.updateUserInfo(null),r.sys.getAllRoles()):p.error("添加失败")}finally{f({modalLoading:!1})}else try{if(!((e=n==null?void 0:n.nowData)!=null&&e.id)){p.error("该数据没有ID");return}o.id=n.nowData.id;const l=await r.sys.upPower(o);l&&l.status===200?(p.success("修改成功"),x(u.id),j(),await R(o.id,g),r.sys.getAllRoles(),r.app.updateUserInfo(null)):p.error("修改失败")}finally{f({modalLoading:!1})}}catch{}},$=async e=>{const t={id:e.id};C(!0);const o=await r.sys.delPower(t);o&&o.status===200?(x(u.id),r.app.updateUserInfo(null),p.success("删除成功")):p.error((o==null?void 0:o.message)??"操作失败")},R=(e,t)=>{const o=y.map(l=>{const a=new Set(l.menuAndPowers.reduce((d,G)=>[...d,...G.powers],[]));return t.includes(l.id)?a.add(e):a.delete(e),{id:l.id,menus:l.menuAndPowers.map(d=>d.menuId),powers:Array.from(a)}});r.sys.setPowersByRoleIds(o)},U=i.useMemo(()=>{const e=Q.cloneDeep(b.menus),t=A(e);return t.sort((o,l)=>o.sorts-l.sorts),T(null,t)||[]},[b.menus,T]),J=[{title:"序号",dataIndex:"serial",key:"serial"},{title:"权限名称",dataIndex:"title",key:"title"},{title:"Code",dataIndex:"code",key:"code"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"状态",dataIndex:"conditions",key:"conditions",render:e=>e===1?s.jsx("span",{style:{color:"green"},children:"启用"}):s.jsx("span",{style:{color:"red"},children:"禁用"})},{title:"操作",key:"control",width:120,render:(e,t)=>{const o=[];h.includes("power:query")&&o.push(s.jsx("span",{className:"control-btn green",onClick:()=>I(t,"see"),children:s.jsx(S,{placement:"top",title:"查看",children:s.jsx(ee,{})})},"0")),h.includes("power:up")&&o.push(s.jsx("span",{className:"control-btn blue",onClick:()=>I(t,"up"),children:s.jsx(S,{placement:"top",title:"修改",children:s.jsx(se,{})})},"1")),h.includes("power:del")&&o.push(s.jsx(oe,{title:"确定删除吗?",okText:"确定",cancelText:"取消",onConfirm:()=>$(t),children:s.jsx("span",{className:"control-btn red",children:s.jsx(S,{placement:"top",title:"删除",children:s.jsx(te,{})})})},"2"));const l=[];return o.forEach((a,d)=>{d&&l.push(s.jsx(le,{type:"vertical"},`line${d}`)),l.push(a)}),l}}],V=i.useMemo(()=>v.map((e,t)=>({key:t,id:e.id,menu:e.menu,title:e.title,code:e.code,desc:e.desc,sorts:e.sorts,conditions:e.conditions,serial:t+1,control:e.id})),[v]),z=i.useMemo(()=>y.map(e=>({label:e.title,value:e.id})),[y]);return s.jsxs("div",{className:"page-power-admin",children:[s.jsxs("div",{className:"l",children:[s.jsx("div",{className:"title",children:"目录结构"}),s.jsx("div",{children:s.jsx(X,{onSelect:F,treeData:U})})]}),s.jsxs("div",{className:"r",children:[s.jsx("div",{className:"searchBox",children:s.jsx("ul",{children:s.jsx("li",{children:s.jsx(H,{type:"primary",icon:s.jsx(Y,{}),onClick:()=>I(null,"add"),disabled:!(u.id&&h.includes("power:add")),children:`添加${u.title||""}权限`})})})}),s.jsx(Z,{className:"diy-table",columns:J,loading:B,dataSource:V,pagination:{showQuickJumper:!0,showTotal:e=>`共 ${e} 条数据`}})]}),s.jsx(_,{title:`${{add:"新增",up:"修改",see:"查看"}[n.operateType]}权限: ${u.title}->${((L=n.nowData)==null?void 0:L.title)??""}`,visible:n.modalShow,onOk:O,onCancel:j,confirmLoading:n.modalLoading,children:s.jsxs(c,{form:w,initialValues:{formConditions:1},children:[s.jsx(c.Item,{label:"权限名",name:"formTitle",...m,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:s.jsx(k,{placeholder:"请输入权限名",disabled:n.operateType==="see"})}),s.jsx(c.Item,{label:"Code",name:"formCode",...m,rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}],children:s.jsx(k,{placeholder:"请输入权限Code",disabled:n.operateType==="see"})}),s.jsx(c.Item,{label:"描述",name:"formDesc",...m,rules:[{max:100,message:"最多输入100位字符"}],children:s.jsx(ie,{rows:4,disabled:n.operateType==="see",autoSize:{minRows:2,maxRows:6}})}),s.jsx(c.Item,{label:"排序",name:"formSorts",...m,rules:[{required:!0,message:"请输入排序号"}],children:s.jsx(ae,{min:0,max:99999,style:{width:"100%"},disabled:n.operateType==="see"})}),s.jsx(c.Item,{label:"状态",name:"formConditions",...m,rules:[{required:!0,message:"请选择状态"}],children:s.jsxs(q,{disabled:n.operateType==="see",children:[s.jsx(E,{value:1,children:"启用"},1),s.jsx(E,{value:-1,children:"禁用"},-1)]})}),s.jsx(c.Item,{label:"赋予",...m,children:s.jsx(re.Group,{disabled:n.operateType==="see",options:z,value:g,onChange:e=>M(e)})})]})})]})}export{me as default};
