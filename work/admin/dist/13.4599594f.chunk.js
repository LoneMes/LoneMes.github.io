(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{1029:function(e,t,a){},1045:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return ue}));a(725);var n,s=a(727),o=a.n(s),r=(a(743),a(740)),i=a.n(r),l=(a(757),a(772)),c=a.n(l),u=(a(729),a(741)),d=a.n(u),p=a(224),m=a.n(p),h=(a(730),a(738)),f=a.n(h),k=(a(312),a(311)),w=a.n(k),y=a(116),v=a.n(y),g=a(2),C=a.n(g),b=a(12),E=a.n(b),S=(a(744),a(750)),x=a.n(S),D=(a(745),a(749)),I=a.n(D),T=(a(219),a(101)),P=a.n(T),R=(a(123),a(9)),M=a.n(R),N=a(20),B=a.n(N),A=a(19),q=a.n(A),J=a(21),L=a.n(J),U=a(22),O=a.n(U),F=a(42),V=a.n(F),j=a(23),z=a.n(j),G=a(30),Q=a.n(G),H=(a(732),a(735)),K=a.n(H),W=(a(731),a(726)),X=a.n(W),Y=(a(758),a(759)),Z=a.n(Y),$=a(0),_=a.n($),ee=a(61),te=a(225),ae=a.n(te),ne=(a(1029),a(1051)),se=a(1050),oe=a(1049),re=a(1048),ie=Z.a.TreeNode,le=X.a.Option,ce=K.a.TextArea,ue=Object(ee.b)((function(e){return{userinfo:e.app.userinfo,powersCode:e.app.powersCode,roles:e.sys.roles}}),(function(e){return{addPower:e.sys.addPower,getMenus:e.sys.getMenus,upPower:e.sys.upPower,delPower:e.sys.delPower,getPowerDataByMenuId:e.sys.getPowerDataByMenuId,updateUserInfo:e.app.updateUserInfo,setPowersByRoleIds:e.sys.setPowersByRoleIds,getAllRoles:e.sys.getAllRoles}}))(n=function(e){function t(e){var a;return B()(this,t),a=L()(this,O()(t).call(this,e)),Q()(V()(a),"onTreeSelect",(function(e,t){t.selected?(a.getData(e[0]),a.setState({treeSelect:{title:t.node.title,id:t.node.id}})):a.setState({treeSelect:{},data:[]})})),Q()(V()(a),"getNameByParentId",(function(e){var t=a.state.data.find((function(t){return t.id===e}));return t?t.title:void 0})),Q()(V()(a),"onModalShow",(function(e,t){a.setState({modalShow:!0,nowData:e,operateType:t,formParent:"add"===t?{label:void 0,value:void 0}:{label:a.getNameByParentId(e.parent),value:e.parent},rolesCheckboxChose:e&&e.id?a.props.roles.filter((function(t){var a=t.menuAndPowers.find((function(t){return t.menuId===e.menu}));return!!a&&a.powers.includes(e.id)})).map((function(e){return e.id})):[]}),setTimeout((function(){"add"===t?a.form.current.resetFields():a.form.current.setFieldsValue({formConditions:e.conditions,formDesc:e.desc,formCode:e.code,formSorts:e.sorts,formTitle:e.title})}))})),Q()(V()(a),"onClose",(function(){a.setState({modalShow:!1})})),Q()(V()(a),"onDel",(function(e){var t={id:e.id};a.setState({loading:!0}),a.props.delPower(t).then((function(e){200===e.status?(a.getData(a.state.treeSelect.id),a.props.updateUserInfo(),M.a.success("删除成功")):M.a.error(e.message)}))})),Q()(V()(a),"makeColumns",(function(){return[{title:"序号",dataIndex:"serial",key:"serial"},{title:"权限名称",dataIndex:"title",key:"title"},{title:"Code",dataIndex:"code",key:"code"},{title:"描述",dataIndex:"desc",key:"desc"},{title:"状态",dataIndex:"conditions",key:"conditions",render:function(e,t){return 1===e?_.a.createElement("span",{style:{color:"green"}},"启用"):_.a.createElement("span",{style:{color:"red"}},"禁用")}},{title:"操作",key:"control",width:120,render:function(e,t){var n=[],s=a.props.powersCode;s.includes("power:query")&&n.push(_.a.createElement("span",{key:"0",className:"control-btn green",onClick:function(){return a.onModalShow(t,"see")}},_.a.createElement(P.a,{placement:"top",title:"查看"},_.a.createElement(ne.a,null)))),s.includes("power:up")&&n.push(_.a.createElement("span",{key:"1",className:"control-btn blue",onClick:function(){return a.onModalShow(t,"up")}},_.a.createElement(P.a,{placement:"top",title:"修改"},_.a.createElement(se.a,null)))),s.includes("power:del")&&n.push(_.a.createElement(I.a,{key:"2",title:"确定删除吗?",okText:"确定",cancelText:"取消",onConfirm:function(){return a.onDel(t)}},_.a.createElement("span",{className:"control-btn red"},_.a.createElement(P.a,{placement:"top",title:"删除"},_.a.createElement(oe.a,null)))));var o=[];return n.forEach((function(e,t){t&&o.push(_.a.createElement(x.a,{key:"line".concat(t),type:"vertical"})),o.push(e)})),o}}]})),Q()(V()(a),"makeRolesCheckbox",(function(){return a.props.roles.map((function(e){return{label:e.title,value:e.id}}))})),Q()(V()(a),"onRolesCheckboxChange",(function(e){a.setState({rolesCheckboxChose:e})})),a.form=_.a.createRef(),a.state={data:[],sourceData:[],loading:!1,treeSelect:{},nowData:null,operateType:"add",modalShow:!1,modalLoading:!1,menuChoseShow:!1,formParent:{label:void 0,value:void 0},rolesCheckboxChose:[]},a}var a;return z()(t,e),q()(t,[{key:"componentDidMount",value:function(){0===this.props.userinfo.menus.length?this.getMenuData():this.makeSourceData(this.props.userinfo.menus),this.props.getAllRoles(),this.getData()}},{key:"componentDidUpdate",value:function(e){e.userinfo.menus!==this.props.userinfo.menus&&this.makeSourceData(this.props.userinfo.menus)}},{key:"getData",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,a=this.props.powersCode;if(a.includes("power:query")){this.setState({loading:!0});var n={menuId:Number(t)||null};this.props.getPowerDataByMenuId(n).then((function(t){200===t.status&&e.setState({data:t.data}),e.setState({loading:!1})})).catch((function(){e.setState({loading:!1})}))}}},{key:"getMenuData",value:function(){this.props.getMenus()}},{key:"makeSourceData",value:function(e){var t=ae.a.cloneDeep(e);t.forEach((function(e){e.key=String(e.id)})),t.sort((function(e,t){return e.sorts-t.sorts}));var a=this.dataToJson(null,t)||[];this.setState({sourceData:a})}},{key:"dataToJson",value:function(e,t){var a,n=this;return(a=e?t.filter((function(t){return t.parent===e.id})):t.filter((function(e){return!e.parent}))).forEach((function(e){return e.children=n.dataToJson(e,t)})),a.length?a:null}},{key:"makeTreeDom",value:function(e){var t=this;return e.map((function(e){return e.children?_.a.createElement(ie,{title:e.title,key:"".concat(e.id),p:e.parent},t.makeTreeDom(e.children)):_.a.createElement(ie,{title:e.title,key:"".concat(e.id),id:e.id,p:e.parent})}))}},{key:"onOk",value:(a=E()(C.a.mark((function e(){var t,a,n;return C.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("see"!==this.state.operateType){e.next=3;break}return this.onClose(),e.abrupt("return");case 3:return e.prev=3,e.next=6,this.form.current.validateFields();case 6:if(t=e.sent,a={title:t.formTitle,code:t.formCode,menu:this.state.treeSelect.id,sorts:t.formSorts,desc:t.formDesc,conditions:t.formConditions},this.setState({modalLoading:!0}),"add"!==this.state.operateType){e.next=30;break}return e.prev=10,e.next=13,this.props.addPower(a);case 13:if(200!==(n=e.sent).status){e.next=24;break}return M.a.success("添加成功"),this.getData(this.state.treeSelect.id),this.onClose(),e.next=20,this.setPowersByRoleIds(n.data.id,this.state.rolesCheckboxChose);case 20:this.props.updateUserInfo(),this.props.getAllRoles(),e.next=25;break;case 24:M.a.error("添加失败");case 25:return e.prev=25,this.setState({modalLoading:!1}),e.finish(25);case 28:e.next=49;break;case 30:return e.prev=30,a.id=this.state.nowData.id,e.next=34,this.props.upPower(a);case 34:if(200!==e.sent.status){e.next=45;break}return M.a.success("修改成功"),this.getData(this.state.treeSelect.id),this.onClose(),e.next=41,this.setPowersByRoleIds(a.id,this.state.rolesCheckboxChose);case 41:this.props.getAllRoles(),this.props.updateUserInfo(),e.next=46;break;case 45:M.a.error("修改失败");case 46:return e.prev=46,this.setState({modalLoading:!1}),e.finish(46);case 49:e.next=53;break;case 51:e.prev=51,e.t0=e.catch(3);case 53:case"end":return e.stop()}}),e,this,[[3,51],[10,,25,28],[30,,46,49]])}))),function(){return a.apply(this,arguments)})},{key:"setPowersByRoleIds",value:function(e,t){this.props.userinfo;var a=this.props.roles.map((function(a){var n=new Set(a.menuAndPowers.reduce((function(e,t){return[].concat(v()(e),v()(t.powers))}),[]));return t.includes(a.id)?n.add(e):n.delete(e),{id:a.id,menus:a.menuAndPowers.map((function(e){return e.menuId})),powers:Array.from(n)}}));this.props.setPowersByRoleIds(a)}},{key:"makeData",value:function(e){return e?e.map((function(e,t){return{key:t,id:e.id,menu:e.menu,title:e.title,code:e.code,desc:e.desc,sorts:e.sorts,conditions:e.conditions,serial:t+1}})):[]}},{key:"render",value:function(){var e,t,a=this,n=this.props.powersCode,s={labelCol:{xs:{span:24},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:19}}};return _.a.createElement("div",{className:"page-power-admin"},_.a.createElement("div",{className:"l"},_.a.createElement("div",{className:"title"},"目录结构"),_.a.createElement("div",null,_.a.createElement(Z.a,{onSelect:this.onTreeSelect,treeData:this.state.sourceData}))),_.a.createElement("div",{className:"r"},_.a.createElement("div",{className:"searchBox"},_.a.createElement("ul",null,_.a.createElement("li",null,_.a.createElement(w.a,{type:"primary",icon:_.a.createElement(re.a,null),onClick:function(){return a.onModalShow(null,"add")},disabled:!(this.state.treeSelect.id&&n.includes("power:add"))},"添加".concat(this.state.treeSelect.title||"","权限"))))),_.a.createElement(f.a,{className:"diy-table",columns:this.makeColumns(),loading:this.state.loading,dataSource:this.makeData(this.state.data),pagination:{showQuickJumper:!0,showTotal:function(e,t){return"共 ".concat(e," 条数据")}}})),_.a.createElement(o.a,{title:"".concat({add:"新增",up:"修改",see:"查看"}[this.state.operateType],"权限: ").concat(this.state.treeSelect.title,"->").concat(null!==(e=null===(t=this.state.nowData)||void 0===t?void 0:t.title)&&void 0!==e?e:""),visible:this.state.modalShow,onOk:function(){return a.onOk()},onCancel:this.onClose,confirmLoading:this.state.modalLoading},_.a.createElement(d.a,{ref:this.form,initialValues:{formConditions:1}},_.a.createElement(d.a.Item,m()({label:"权限名",name:"formTitle"},s,{rules:[[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}]]}),_.a.createElement(K.a,{placeholder:"请输入权限名",disabled:"see"===this.state.operateType})),_.a.createElement(d.a.Item,m()({label:"Code",name:"formCode"},s,{rules:[{required:!0,whitespace:!0,message:"必填"},{max:12,message:"最多输入12位字符"}]}),_.a.createElement(K.a,{placeholder:"请输入权限Code",disabled:"see"===this.state.operateType})),_.a.createElement(d.a.Item,m()({label:"描述",name:"formDesc"},s,{rules:[{max:100,message:"最多输入100位字符"}]}),_.a.createElement(ce,{rows:4,disabled:"see"===this.state.operateType,placeholoder:"请输入描述",autosize:{minRows:2,maxRows:6}})),_.a.createElement(d.a.Item,m()({label:"排序",name:"formSorts"},s,{rules:[{required:!0,message:"请输入排序号"}]}),_.a.createElement(c.a,{min:0,max:99999,style:{width:"100%"},disabled:"see"===this.state.operateType})),_.a.createElement(d.a.Item,m()({label:"状态",name:"formConditions"},s,{rules:[{required:!0,message:"请选择状态"}]}),_.a.createElement(X.a,{disabled:"see"===this.state.operateType},_.a.createElement(le,{key:1,value:1},"启用"),_.a.createElement(le,{key:-1,value:-1},"禁用"))),_.a.createElement(d.a.Item,m()({label:"赋予"},s),_.a.createElement(i.a.Group,{options:this.makeRolesCheckbox(),value:this.state.rolesCheckboxChose,onChange:this.onRolesCheckboxChange})))))}}]),t}(_.a.Component))||n}}]);